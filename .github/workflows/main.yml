
name: Build+Deploy main
on:
  push:
    branches: [main]

env: 
  IMAGE_TAG: ${{ github.sha }}

permissions:
  id-token: write
  contents: read

jobs:
  build:
    runs-on: self-hosted
    steps:
      - name: checkout code 
        uses: actions/checkout@v3
        with:
          ref: ${{ inputs.version }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-2

      # Copy the file to S3
      - name: Copy file to S3
        run: |
          pwd
          ls 
          aws s3 cp flaskapp/app.py  s3://flask-app-resources/destination/app.py


  deploy-useast2:
    runs-on: self-hosted
    needs: build
    steps:
      - name: checkout code 
        uses: actions/checkout@v3
        with:
          ref: ${{ inputs.version }}

      - name: cdk synth 
        working-directory: ./infrastructure
        run: |
          cdk --version
          npm ci
          npm install
          cdk synth
          cdk list
          cdk deploy dev-us-east-2/app/App

  deploy-useast1:
    runs-on: self-hosted
    needs: build
    steps:
      - name: checkout code 
        uses: actions/checkout@v3
        with:
          ref: ${{ inputs.version }}

      - name: cdk synth 
        working-directory: ./infrastructure
        run: |
          cdk --version
          npm ci
          npm install
          cdk synth
          cdk list
          cdk deploy dev-us-east-1/app/App

  approval-useast1:
    runs-on: self-hosted
    needs: deploy-useast1
    steps:
      - name: Approval needed
        uses: actions/github-script@v5
        with:
          script: |
            const res = await github.repos.createDispatchEvent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              event_type: "approval",
            });
            console.log(res.data);
  prod-deploy-useast1:
    runs-on: self-hosted
    needs: [deploy-useast1, approval-useast1]
    steps:
      - name: checkout code 
        uses: actions/checkout@v3
        with:
          ref: ${{ inputs.version }}

      - name: cdk synth 
        working-directory: ./infrastructure
        run: |
          cdk --version
          npm ci
          npm install
          cdk synth
          cdk list
          cdk deploy dev-us-east-1/app/App

  approval-useast2:
    runs-on: self-hosted
    needs: deploy-useast2
    steps:
      - name: Approval needed
        uses: actions/github-script@v5
        with:
          script: |
            const res = await github.repos.createDispatchEvent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              event_type: "approval",
            });
            console.log(res.data);

  prod-deploy-useast2:
    runs-on: self-hosted
    needs: [deploy-useast2, approval-useast2]
    steps:
      - name: checkout code
        uses: actions/checkout@v3
        with:
          ref: ${{ inputs.version }}

      - name: cdk synth 
        working-directory: ./infrastructure
        run: |
          cdk --version
          npm ci
          npm install
          cdk synth
          cdk list
          cdk deploy dev-us-east-1/app/App

